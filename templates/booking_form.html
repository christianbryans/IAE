{% extends "base.html" %}

{% block title %}Book Ticket{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title mb-4">
                        <i class="fas fa-ticket-alt me-2"></i>Book a Ticket
                    </h2>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="{{ url_for('booking') }}" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="passenger_name" class="form-label">Passenger Name</label>
                            <input type="text" class="form-control" id="passenger_name" name="passenger_name" required>
                            <div class="form-text">Enter the name of the person who will be traveling</div>
                        </div>

                        <div class="mb-3">
                            <label for="departure_airport" class="form-label">From</label>
                            <input type="text" class="form-control" id="departure_airport" name="departure_airport" required>
                            <div id="departure_suggestions" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="destination_airport" class="form-label">To</label>
                            <input type="text" class="form-control" id="destination_airport" name="destination_airport" required>
                            <div id="destination_suggestions" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="travel_date" class="form-label">Travel Date</label>
                            <input type="date" class="form-control" id="travel_date" name="travel_date" required>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>Book Ticket
                            </button>
                            <a href="{{ url_for('tickets') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Tickets
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form validation
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()

// Airport search functionality
function setupAirportSearch(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);
    let timeoutId;

    input.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const query = this.value;
        
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }

        timeoutId = setTimeout(() => {
            fetch(`/api/airports?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestions.innerHTML = '';
                    data.forEach(airport => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <strong>${airport.name}</strong>
                                <small class="text-muted">${airport.code}</small>
                            </div>
                            <small class="text-muted">${airport.city}</small>
                        `;
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            input.value = `${airport.name} (${airport.code})`;
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(item);
                    });
                    suggestions.style.display = data.length ? 'block' : 'none';
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });
}

setupAirportSearch('departure_airport', 'departure_suggestions');
setupAirportSearch('destination_airport', 'destination_suggestions');
</script>
{% endblock %}
